<!DOCTYPE html>
<html lang="en" data-theme="mono">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spanish Drill — U1A1 / Numbers / U1A2</title>
<style>
  /* ===== THEME ===== */
  :root{
    --bg:#0f0f0f; --surface:#151515; --ink:#eaeaea; --muted:#a9a9a9; --line:#2a2a2a;
    --ok:#2bd97f; --bad:#ff6363; --warn:#f2c94c; --accent:#d0d0d0;
    --shadow:0 10px 28px rgba(0,0,0,.25);
    --focus:0 0 0 2px #000, 0 0 0 4px rgba(124,145,255,.6);
  }
  [data-theme="color"]{
    --bg:#0f1320; --surface:#171a2b; --ink:#e7eaf1; --muted:#9aa3b2; --line:#232742;
    --ok:#36d399; --bad:#ff6b6b; --warn:#fbbf24; --accent:#7c91ff;
    --shadow:0 16px 36px rgba(8,12,32,.45);
    --focus:0 0 0 2px #0b0e18, 0 0 0 4px rgba(124,145,255,.6);
  }

  /* ===== RESET + BASE ===== */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial}
  a{color:inherit;text-decoration:none}
  button{cursor:pointer}
  .wrap{max-width:1100px;margin:auto;padding:24px}
  .hidden{display:none!important}
  :focus-visible{outline:none;box-shadow:var(--focus);border-radius:12px}

  /* ===== LAYOUT ===== */
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
  .brand{font-weight:800;letter-spacing:.2px}
  .pill{display:flex;align-items:center;gap:8px;background:#101010;border:1px solid var(--line);padding:8px 12px;border-radius:12px}
  [data-theme="color"] .pill{background:#101428}
  select, input[type="number"], input[type="text"]{
    background:#0e0e0e;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:6px 8px
  }
  [data-theme="color"] select,[data-theme="color"] input{background:#0b0e18;border-color:#303756}

  .btn{border:1px solid var(--line);background:#101010;color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:600;transition:transform .06s ease,border-color .2s ease}
  [data-theme="color"] .btn{background:#101428}
  .btn:hover{border-color:var(--accent)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{border-color:transparent;background:linear-gradient(180deg,var(--accent),#b9b9b9);color:#121212}
  .btn[disabled]{opacity:.5;pointer-events:none}

  .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
  .pad{padding:18px}
  .muted{color:var(--muted)}
  .tag{padding:6px 10px;border-radius:999px;background:#0f0f0f;border:1px solid var(--line);color:var(--muted);font-size:12.5px}

  /* ===== VIEWS (smooth flow) ===== */
  .view{opacity:0;transform:translateY(8px);pointer-events:none;transition:opacity .25s ease,transform .25s ease}
  .view.active{opacity:1;transform:none;pointer-events:auto}

  /* ===== HOME (select a set) ===== */
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
  .tile{display:flex;flex-direction:column;justify-content:space-between;min-height:120px}
  .tile h2{margin:0 0 6px;font-size:22px}
  .tile p{margin:0;color:var(--muted)}

  /* ===== STUDY PAGE ===== */
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
  .table thead th{position:sticky;top:0;background:#0f0f0f;color:var(--muted);text-align:left;padding:10px;border-bottom:1px solid var(--line);z-index:1}
  .table tbody td{padding:10px;border-bottom:1px solid var(--line)}
  [data-theme="color"] .table thead th{background:#11162a}

  /* ===== DRILL ===== */
  .flex{display:flex;gap:14px;align-items:stretch}
  .main{flex:1}
  .side{width:360px;max-width:40%;min-width:280px}
  .slide{transform:translateX(12px);opacity:0;pointer-events:none;transition:transform .25s ease,opacity .25s ease}
  .slide.show{transform:none;opacity:1;pointer-events:auto}
  h1{margin:0 0 10px;font-size:22px}
  #prompt{font-size:28px;font-weight:800;margin:6px 0 10px;word-break:break-word}
  #answer{width:100%;font-size:22px;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0e0e0e;color:var(--ink)}
  [data-theme="color"] #answer{background:#0b0e18;border-color:#303756}
  .accentbar{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
  .accentbar button{padding:6px 8px;border-radius:10px;border:1px solid var(--line);background:#0e0e0e}
  .accentbar button:hover{border-color:var(--accent)}
  progress{width:100%;height:10px;border-radius:999px;margin-top:8px}
  /* progress styling (fallbacks kept simple) */
  progress::-webkit-progress-bar{background:#0b0b0b;border-radius:999px}
  progress::-webkit-progress-value{background:linear-gradient(90deg,var(--ok),#71e9b7);border-radius:999px}

  /* Correct/Incorrect flash */
  .flash-ok{animation:flashOk .4s}
  .flash-bad{animation:flashBad .4s}
  @keyframes flashOk{from{box-shadow:0 0 0 0 rgba(43,217,127,.0)}50%{box-shadow:0 0 0 6px rgba(43,217,127,.25)}to{box-shadow:0 0 0 0 rgba(43,217,127,.0)}}
  @keyframes flashBad{from{box-shadow:0 0 0 0 rgba(255,99,99,.0)}50%{box-shadow:0 0 0 6px rgba(255,99,99,.25)}to{box-shadow:0 0 0 0 rgba(255,99,99,.0)}}

  /* ===== TOUR ===== */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
  .overlay.show{opacity:1;pointer-events:auto}
  .modal{max-width:680px;width:92%;background:var(--surface);border:1px solid var(--line);border-radius:14px;padding:16px}
  .modal h3{margin:0 0 6px}
  .bullets{margin:8px 0 0 18px;color:var(--muted)}

  /* ===== MOBILE ===== */
  @media (max-width: 900px){
    .flex{flex-direction:column}
    .side{width:100%;max-width:none;min-width:auto}
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- Top -->
  <div class="topbar">
    <div class="brand">Spanish Drill</div>
    <div class="pill" role="group" aria-label="Theme">
      Theme:
      <select id="themeSel" aria-label="Theme select">
        <option value="mono">Monochrome</option>
        <option value="color">Color</option>
      </select>
    </div>
  </div>

  <!-- HOME: choose a set -->
  <section id="homeView" class="view active" aria-labelledby="homeTitle">
    <h1 id="homeTitle" class="hidden">Choose a Set</h1>
    <div class="grid">
      <div class="card pad tile">
        <div>
          <h2>U1A1</h2>
          <p>20 terms</p>
        </div>
        <div>
          <button class="btn" data-open="u1a1" data-go="activity">Open</button>
        </div>
      </div>
      <div class="card pad tile">
        <div>
          <h2>Numbers</h2>
          <p>0–20</p>
        </div>
        <div>
          <button class="btn" data-open="numbers" data-go="activity">Open</button>
        </div>
      </div>
      <div class="card pad tile">
        <div>
          <h2>U1A2</h2>
          <p>15 terms</p>
        </div>
        <div>
          <button class="btn" data-open="u1a2" data-go="activity">Open</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ACTIVITY: Study or Drill -->
  <section id="activityView" class="view" aria-labelledby="activityTitle">
    <div class="card pad" style="margin-bottom:12px">
      <div class="controls">
        <button class="btn" id="backHome">← Back</button>
        <span class="tag" id="setTag">Set</span>
      </div>
      <h2 id="activityTitle" class="hidden">Choose Activity</h2>
      <div class="grid">
        <div class="card pad tile">
          <div>
            <h2>Study</h2>
            <p>Browse the list, hear audio, hide columns.</p>
          </div>
          <div><button class="btn" id="goStudy">Open Study</button></div>
        </div>
        <div class="card pad tile">
          <div>
            <h2>Drill</h2>
            <p>Spell answers. Optional math for Numbers.</p>
          </div>
          <div><button class="btn" id="goDrill">Start Drill</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- STUDY PAGE -->
  <section id="studyView" class="view" aria-labelledby="studyTitle">
    <div class="card pad" style="margin-bottom:12px">
      <div class="controls">
        <button class="btn" id="backActivity1">← Back</button>
        <span class="tag" id="studySetTag">Set</span>
        <div class="pill">Hide:
          <label><input type="checkbox" id="hideEs"> Spanish</label>
          <label><input type="checkbox" id="hideEn"> English</label>
        </div>
        <div class="pill">Filter: <input id="filterBox" placeholder="type to filter…" aria-label="Filter terms"></div>
        <button class="btn" id="studyToDrill">Start Drill</button>
      </div>
      <h2 id="studyTitle" class="hidden">Study List</h2>
      <div class="card pad" style="padding:0;max-height:65vh;overflow:auto">
        <table class="table" id="studyTable">
          <thead><tr><th style="width:50%">Spanish</th><th style="width:46%">English</th><th style="width:4%"></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- DRILL PAGE -->
  <section id="drillView" class="view" aria-labelledby="drillTitle">
    <div class="controls">
      <button class="btn" id="backActivity2">← Back</button>
      <span class="tag" id="drillSetTag">Set</span>
      <div class="pill">Direction:
        <label><input type="radio" name="mode" value="en2es" checked> EN→ES</label>
        <label><input type="radio" name="mode" value="es2en"> ES→EN</label>
        <label id="mathLabel" class="hidden"><input type="radio" name="mode" value="math"> Math</label>
      </div>
      <div class="pill">Strict accents <input id="strict" type="checkbox" aria-label="Strict accents"></div>
      <div class="pill">Shuffle <input id="shuffle" type="checkbox" checked aria-label="Shuffle"></div>
      <button class="btn" id="tourBtn" title="Quick tour">? Tour</button>
      <button class="btn" id="panelBtn" aria-expanded="false">☰ Study Panel</button>
    </div>

    <!-- Math options (Numbers only) -->
    <div id="mathOps" class="card pad hidden" aria-live="polite">
      <div class="controls">
        <div class="pill">Operations:
          <label><input type="checkbox" id="opAdd" checked> +</label>
          <label><input type="checkbox" id="opSub" checked> −</label>
          <label><input type="checkbox" id="opDiv" checked> ÷</label>
        </div>
        <div class="pill">Questions: <input id="qCount" type="number" min="5" max="40" value="20" style="width:72px" aria-label="Question count"></div>
        <span class="muted">Operands/results ≤ 20. Answers only from your list.</span>
      </div>
    </div>

    <div class="flex">
      <!-- Main drill -->
      <div class="card pad main" id="mainCard">
        <h1 id="title">Type the Spanish term for:</h1>
        <div id="prompt">—</div>

        <input id="answer" type="text" placeholder="Type your answer, then press Enter or click Check" autocomplete="off" aria-label="Answer" />
        <div class="accentbar" aria-label="Accent helper">
          <button class="btn" data-ins="á">á</button>
          <button class="btn" data-ins="é">é</button>
          <button class="btn" data-ins="í">í</button>
          <button class="btn" data-ins="ó">ó</button>
          <button class="btn" data-ins="ú">ú</button>
          <button class="btn" data-ins="ñ">ñ</button>
          <button class="btn" data-ins="¡">¡</button>
          <button class="btn" data-ins="¿">¿</button>
        </div>

        <div class="controls" style="margin-top:8px">
          <button class="btn" id="audioBtn" title="Alt+A">🔊 Audio</button>
          <button class="btn primary" id="checkBtn" title="Enter">Check</button>
          <button class="btn" id="hintBtn" title="Shift+Enter">Hint</button>
          <button class="btn" id="skipBtn" title="Alt+S">Skip</button>
          <span class="tag" id="scoreTag">0 / 0</span>
          <span class="tag" id="streakTag">streak 0</span>
          <span class="tag" id="remainTag">— left</span>
        </div>
        <div id="feedback" class="muted" aria-live="polite"></div>
        <progress id="prog" value="0" max="20"></progress>
      </div>

      <!-- Study side panel -->
      <div class="side">
        <div id="studyPanel" class="card pad slide" aria-hidden="true">
          <div class="controls" style="justify-content:space-between">
            <div class="muted">Word list</div>
            <div class="pill">Hide:
              <label><input type="checkbox" id="pHideEs"> ES</label>
              <label><input type="checkbox" id="pHideEn"> EN</label>
            </div>
          </div>
          <div style="max-height:60vh;overflow:auto;margin-top:6px">
            <table class="table" id="panelTable">
              <thead><tr><th style="width:50%">Spanish</th><th style="width:46%">English</th><th style="width:4%"></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Finish -->
    <div id="finish" class="card pad" style="margin-top:12px;display:none">
      <h1>Round complete</h1>
      <div id="summary" class="muted"></div>
      <div class="controls" style="margin-top:6px">
        <button class="btn" id="restartBtn">Restart</button>
        <button class="btn" id="retryWrongBtn" style="display:none">Retry Missed Only</button>
        <button class="btn" id="copyMissedBtn">Copy Missed</button>
      </div>
    </div>
  </section>
</div>

<!-- TOUR OVERLAY -->
<div id="tour" class="overlay" aria-modal="true" role="dialog" aria-labelledby="tourTitle">
  <div class="modal">
    <h3 id="tourTitle">Quick tour</h3>
    <ul class="bullets">
      <li>Pick EN→ES or ES→EN. If you chose Numbers, you can switch to Math for +/−/÷.</li>
      <li>Use “☰ Study Panel” (or press Esc) to show/hide the live word list while drilling.</li>
      <li>“Strict accents” enforces accents/punctuation. Turn it off to ignore them.</li>
      <li>Missed items reappear again a few cards later for spaced practice.</li>
      <li>Click 🔊 (Alt+A) to hear Spanish audio for the correct answer.</li>
      <li>Enter = Check, Shift+Enter = Hint, Alt+S = Skip.</li>
    </ul>
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="closeTour">Close</button>
    </div>
  </div>
</div>

<script>
/* ============ DATA ============ */
const SETS = {
  u1a1:{items:[
    {es:"el acento", en:"accent"},{es:"Adiós", en:"Good-bye"},{es:"el alfabeto", en:"alphabet"},
    {es:"¿cómo?", en:"how?"},{es:"¿Cómo te llamas?", en:"What is your name?"},{es:"con", en:"with"},
    {es:"Hasta luego", en:"See you later"},{es:"Hola", en:"Hello"},{es:"luego", en:"later"},
    {es:"la mayúscula", en:"capital (uppercase) letter"},{es:"me llamo", en:"my name is"},
    {es:"la minúscula", en:"lowercase letter"},{es:"la muchacha", en:"girl, young woman"},
    {es:"el muchacho", en:"boy, young man"},{es:"Mucho gusto.", en:"Glad (Nice) to meet you."},
    {es:"se escribe", en:"it is written"},{es:"sí", en:"yes"},{es:"te llamas", en:"your name is"},
    {es:"yo", en:"I"},{es:"y", en:"and"}
  ]},
  numbers:{items:[
    {es:"catorce", en:"fourteen"},{es:"ocho", en:"eight"},{es:"dieciocho", en:"eighteen"},
    {es:"once", en:"eleven"},{es:"quince", en:"fifteen"},{es:"cinco", en:"five"},
    {es:"cuatro", en:"four"},{es:"nueve", en:"nine"},{es:"diecinueve", en:"nineteen"},
    {es:"uno", en:"one"},{es:"siete", en:"seven"},{es:"diecisiete", en:"seventeen"},
    {es:"seis", en:"six"},{es:"dieciséis", en:"sixteen"},{es:"diez", en:"ten"},
    {es:"trece", en:"thirteen"},{es:"tres", en:"three"},{es:"doce", en:"twelve"},
    {es:"veinte", en:"twenty"},{es:"cero", en:"zero"},{es:"dos", en:"two"}
  ]},
  u1a2:{items:[
    {es:"¿Cuántos años tienes?", en:"How old are you?"},
    {es:"¿De dónde eres?",       en:"Where are you from?"},
    {es:"aquí",                  en:"here"},
    {es:"de",                    en:"from"},
    {es:"edad",                  en:"age"},
    {es:"el país",               en:"the country"},
    {es:"eres",                  en:"you are"},
    {es:"es",                    en:"is"},
    {es:"la capital",            en:"the capital"},
    {es:"me llamo",              en:"my name is"},
    {es:"soy",                   en:"I am"},
    {es:"tengo",                 en:"I have"},
    {es:"tienes",                en:"you have"},
    {es:"tú",                    en:"you"},
    {es:"yo",                    en:"I"}
  ]}
};
/* Numbers mapping for math answers (only allowed results) */
const NUM_TO_ES = {0:"cero",1:"uno",2:"dos",3:"tres",4:"cuatro",5:"cinco",6:"seis",7:"siete",8:"ocho",9:"nueve",10:"diez",11:"once",12:"doce",13:"trece",14:"catorce",15:"quince",16:"dieciséis",17:"diecisiete",18:"dieciocho",19:"diecinueve",20:"veinte"};
const ALLOWED_RESULTS = Object.keys(NUM_TO_ES).map(n=>+n);
const RANGE_MIN=0,RANGE_MAX=20;

/* ============ DOM ============ */
const $=id=>document.getElementById(id);
const themeSel=$('themeSel');
const views={home:$('homeView'), activity:$('activityView'), study:$('studyView'), drill:$('drillView')};
const setTag=$('setTag'), studySetTag=$('studySetTag'), drillSetTag=$('drillSetTag');
const backHome=$('backHome'), goStudy=$('goStudy'), goDrill=$('goDrill'), backActivity1=$('backActivity1'), backActivity2=$('backActivity2');
const studyTable=$('studyTable').querySelector('tbody'), panelTable=$('panelTable').querySelector('tbody');
const hideEs=$('hideEs'), hideEn=$('hideEn'), filterBox=$('filterBox');
const pHideEs=$('pHideEs'), pHideEn=$('pHideEn');
const strict=$('strict'), shuffle=$('shuffle');
const modeRadios=[...document.querySelectorAll('input[name="mode"]')], mathLabel=$('mathLabel'), mathOps=$('mathOps');
const opAdd=$('opAdd'), opSub=$('opSub'), opDiv=$('opDiv'), qCount=$('qCount');
const title=$('title'), promptEl=$('prompt'), answer=$('answer'), mainCard=$('mainCard');
const audioBtn=$('audioBtn'), checkBtn=$('checkBtn'), hintBtn=$('hintBtn'), skipBtn=$('skipBtn');
const scoreTag=$('scoreTag'), streakTag=$('streakTag'), remainTag=$('remainTag'), prog=$('prog');
const finish=$('finish'), summary=$('summary'), restartBtn=$('restartBtn'), retryWrongBtn=$('retryWrongBtn'), copyMissedBtn=$('copyMissedBtn');
const panelBtn=$('panelBtn'), studyPanel=$('studyPanel');
const tour=$('tour'), tourBtn=$('tourBtn'), closeTour=$('closeTour');

/* ============ STATE ============ */
let currentSetKey=null, currentItems=[];
let queue=[], idx=0, seen=0, correct=0, streak=0, revealed=0, wrongIdx=[];
let dir='en2es'; // or 'es2en' or 'math'

/* ============ HELPERS ============ */
function nav(to){
  Object.values(views).forEach(v=>v.classList.remove('active'));
  views[to].classList.add('active');
  window.scrollTo({top:0,behavior:'auto'});
}
function shuffleInPlace(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}
/* FIX: lenient=true => ignore accents/punct; strict=true => compare exactly */
function normalize(s,lenient){
  s=(s||"").trim().toLowerCase().replace(/\s+/g,' ');
  if(lenient){
    s=s.normalize('NFD').replace(/\p{Diacritic}/gu,''); // strip accents
    s=s.replace(/[.,/#!$%^&*;:{}=\-_`~()¿¡?'"…]/g,'');   // strip punctuation
  }
  return s;
}
function speak(text){
  try{
    const u=new SpeechSynthesisUtterance(text);
    u.lang='es-ES';
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){}
}
function setPanel(open){
  studyPanel.classList.toggle('show',open);
  studyPanel.setAttribute('aria-hidden', String(!open));
  panelBtn.setAttribute('aria-expanded', String(open));
}

/* ============ HOME -> ACTIVITY ============ */
document.querySelectorAll('[data-go="activity"]').forEach(b=>{
  b.onclick=()=>{
    currentSetKey = b.dataset.open;
    currentItems = SETS[currentSetKey].items;
    setTag.textContent = currentSetKey.toUpperCase();
    nav('activity');
  };
});
backHome.onclick=()=>nav('home');

/* ============ STUDY ============ */
function renderStudy(list){
  studyTable.innerHTML='';
  list.forEach((it,i)=>{
    const tr=document.createElement('tr');
    const tdEs=document.createElement('td'); tdEs.textContent=it.es; tdEs.className='col-es';
    const tdEn=document.createElement('td'); tdEn.textContent=it.en; tdEn.className='col-en';
    const tdBtn=document.createElement('td');
    const b=document.createElement('button'); b.className='btn'; b.textContent='🔊'; b.title='Play audio'; b.onclick=()=>speak(it.es);
    tdBtn.appendChild(b);
    tr.append(tdEs,tdEn,tdBtn);
    studyTable.appendChild(tr);
  });
  applyStudyHides();
}
function applyStudyHides(){
  document.querySelectorAll('#studyTable .col-es').forEach(td=>td.style.visibility=hideEs.checked?'hidden':'visible');
  document.querySelectorAll('#studyTable .col-en').forEach(td=>td.style.visibility=hideEn.checked?'hidden':'visible');
}
hideEs.onchange=applyStudyHides; hideEn.onchange=applyStudyHides;

filterBox.oninput=()=>{
  const q=filterBox.value.trim().toLowerCase();
  const filtered = !q? currentItems : currentItems.filter(it=>it.es.toLowerCase().includes(q)||it.en.toLowerCase().includes(q));
  renderStudy(filtered);
};

goStudy.onclick=()=>{
  studySetTag.textContent=currentSetKey.toUpperCase();
  filterBox.value=''; hideEs.checked=false; hideEn.checked=false;
  renderStudy(currentItems);
  nav('study');
};
backActivity1.onclick=()=>nav('activity');
$('studyToDrill').onclick=()=>{ goDrill.click(); };

/* ============ DRILL ============ */
function mathPool(ops){
  const pool=[], inRange=n=>n>=RANGE_MIN&&n<=RANGE_MAX, known=n=>ALLOWED_RESULTS.includes(n);
  for(let a=RANGE_MIN;a<=RANGE_MAX;a++){
    for(let b=RANGE_MIN;b<=RANGE_MAX;b++){
      if(ops.add){ const r=a+b; if(inRange(r)&&known(r)) pool.push({q:`${a} + ${b} = ?`, es:NUM_TO_ES[r]}); }
      if(ops.sub){ const r=a-b; if(r>=0&&known(r)) pool.push({q:`${a} - ${b} = ?`, es:NUM_TO_ES[r]}); }
      if(ops.div && b!==0 && a%b===0){ const r=a/b; if(Number.isInteger(r)&&inRange(r)&&known(r)) pool.push({q:`${a} ÷ ${b} = ?`, es:NUM_TO_ES[r]}); }
    }
  }
  const uniq=[], seenTxt=new Set(); for(const it of pool){ if(!seenTxt.has(it.q)){ seenTxt.add(it.q); uniq.push(it); } }
  return uniq;
}
function buildPanel(list){
  panelTable.innerHTML='';
  list.forEach(it=>{
    const tr=document.createElement('tr');
    const tdEs=document.createElement('td'); tdEs.textContent=it.es; tdEs.className='p-es';
    const tdEn=document.createElement('td'); tdEn.textContent=it.en; tdEn.className='p-en';
    const tdBtn=document.createElement('td'); const b=document.createElement('button'); b.className='btn'; b.textContent='🔊'; b.title='Play audio'; b.onclick=()=>speak(it.es);
    tdBtn.appendChild(b); tr.append(tdEs,tdEn,tdBtn); panelTable.appendChild(tr);
  });
  pHideEs.onchange=()=>{document.querySelectorAll('.p-es').forEach(td=>td.style.visibility=pHideEs.checked?'hidden':'visible')};
  pHideEn.onchange=()=>{document.querySelectorAll('.p-en').forEach(td=>td.style.visibility=pHideEn.checked?'hidden':'visible')};
  pHideEs.onchange(); pHideEn.onchange();
}
function buildRound(fromWrong=false){
  wrongIdx = fromWrong ? wrongIdx : [];
  if(dir==='math'){
    const ops={add:opAdd.checked,sub:opSub.checked,div:opDiv.checked}; if(!ops.add&&!ops.sub&&!ops.div){ops.add=true;opAdd.checked=true}
    let pool=mathPool(ops); if(pool.length===0){ alert('No valid math items; change ops.'); return; }
    const n=Math.max(5,Math.min(40, +qCount.value||20));
    shuffleInPlace(pool); currentItems = pool.slice(0,n);
    queue = currentItems.map((_,i)=>i);
  }else{
    currentItems = SETS[currentSetKey].items;
    queue = fromWrong ? wrongIdx.slice() : currentItems.map((_,i)=>i);
    if(shuffle.checked && !fromWrong) shuffleInPlace(queue);
  }
  idx=0; seen=0; correct=0; streak=0; revealed=0; wrongIdx=[];
  prog.max = queue.length; prog.value=0;
  remainTag.textContent = queue.length+" left";
  finish.style.display='none';
  setPanel(false);
  buildPanel(SETS[currentSetKey].items);
  nextCard(); updateHud();
}
function promptFor(i){
  if(dir==='math'){ title.textContent="Solve → type Spanish number"; return currentItems[i].q; }
  if(dir==='en2es'){ title.textContent="Type the Spanish term for:"; return currentItems[i].en; }
  title.textContent="Type the English meaning of:"; return currentItems[i].es;
}
function goldAnswerFor(i){
  if(dir==='math') return currentItems[i].es;
  return (dir==='en2es') ? currentItems[i].es : currentItems[i].en;
}
function nextCard(){
  if(idx>=queue.length){ return endRound(); }
  revealed=0; feedback('','muted'); // clear
  const qi = queue[idx];
  promptEl.textContent = promptFor(qi);
  answer.value=""; answer.focus();
  remainTag.textContent = (queue.length - idx) + " left";
  prog.value = idx;
}
function endRound(){
  summary.innerHTML = `Score <b>${correct}</b> / ${queue.length} • Accuracy ${Math.round(100*correct/Math.max(1,queue.length))}%`;
  finish.style.display='block';
  retryWrongBtn.style.display = wrongIdx.length ? 'inline-block' : 'none';
}
function updateHud(){ scoreTag.textContent = `${correct} / ${seen}`; streakTag.textContent = `streak ${streak}`; }
function feedback(msg, tone){
  const el=$('feedback');
  el.className = tone==='ok'?'':'muted';
  if(tone==='ok') el.style.color='var(--ok)';
  else if(tone==='bad') el.style.color='var(--bad)';
  else if(tone==='warn') el.style.color='var(--warn)';
  else el.style.color='var(--muted)';
  el.textContent = msg;
}
function flash(tone){
  mainCard.classList.remove('flash-ok','flash-bad');
  void mainCard.offsetWidth; // reflow to restart animation
  mainCard.classList.add(tone==='ok'?'flash-ok':'flash-bad');
}

goDrill.onclick=()=>{
  drillSetTag.textContent=currentSetKey.toUpperCase();
  // show math option only for Numbers
  const isNum = currentSetKey==='numbers';
  mathLabel.classList.toggle('hidden', !isNum);
  const mathRadio=document.querySelector('input[name="mode"][value="math"]');
  if(!isNum && mathRadio.checked) document.querySelector('input[name="mode"][value="en2es"]').checked=true;
  dir = document.querySelector('input[name="mode"]:checked').value;
  mathOps.classList.toggle('hidden', !(isNum && dir==='math'));
  buildRound(false);
  nav('drill');
};
backActivity2.onclick=()=>nav('activity');

modeRadios.forEach(r=>r.addEventListener('change', ()=>{
  dir = document.querySelector('input[name="mode"]:checked').value;
  const isNum = currentSetKey==='numbers';
  mathOps.classList.toggle('hidden', !(isNum && dir==='math'));
  savePrefs();
  buildRound(false);
}));
[opAdd,opSub,opDiv,qCount,shuffle].forEach(x=>x.addEventListener('change', ()=>{ savePrefs(); buildRound(false) }));

audioBtn.onclick=()=>{ if(idx<queue.length){ speak(goldAnswerFor(queue[idx])); } };
checkBtn.onclick=()=>{
  if(idx>=queue.length) return;
  seen++;
  const want = normalize(goldAnswerFor(queue[idx]), !strict.checked);
  const got  = normalize(answer.value, !strict.checked);
  if(got && got===want){
    correct++; streak++;
    feedback('Correct: '+goldAnswerFor(queue[idx]), 'ok'); flash('ok');
    idx++;
  }else{
    streak=0;
    feedback('Incorrect. Correct: '+goldAnswerFor(queue[idx]), 'bad'); flash('bad');
    const againIndex = Math.min(queue.length, idx+3);
    queue.splice(againIndex,0,queue[idx]);
    wrongIdx.push(queue[idx]);
    idx++;
  }
  updateHud();
  setTimeout(nextCard, 420);
};
hintBtn.onclick=()=>{
  if(idx>=queue.length) return;
  const ans = goldAnswerFor(queue[idx]);
  revealed = Math.min(ans.length, revealed + Math.max(1, Math.ceil(ans.length*0.12)));
  answer.value = ans.slice(0, revealed);
  feedback('Hint used','warn');
  answer.focus(); answer.setSelectionRange(answer.value.length, answer.value.length);
};
skipBtn.onclick=()=>{
  if(idx>=queue.length) return;
  wrongIdx.push(queue[idx]);
  const againIndex = Math.min(queue.length, idx+3);
  queue.splice(againIndex,0,queue[idx]);
  seen++; streak=0; updateHud();
  feedback('Skipped. Answer: '+goldAnswerFor(queue[idx]), ''); 
  idx++; setTimeout(nextCard, 380);
};
restartBtn.onclick=()=>buildRound(false);
retryWrongBtn.onclick=()=>{ queue = wrongIdx.slice(); idx=0; seen=0; correct=0; streak=0; revealed=0; wrongIdx=[]; prog.max=queue.length; prog.value=0; finish.style.display='none'; nextCard(); updateHud(); };
copyMissedBtn.onclick=async ()=>{
  if(!wrongIdx.length){ try{await navigator.clipboard.writeText('No misses.');}catch{} return; }
  const lines = wrongIdx.map(i=>{
    if(dir==='math') return `${currentItems[i].q}  →  ${currentItems[i].es}`;
    // show both directions for clarity
    return `ES: ${currentItems[i].es}  →  EN: ${currentItems[i].en}`;
  });
  try{ await navigator.clipboard.writeText(lines.join('\n')); feedback('Missed items copied.',''); }catch{}
};
panelBtn.onclick=()=>{ setPanel(!studyPanel.classList.contains('show')); };

/* Accent helper clicks */
document.querySelectorAll('.accentbar [data-ins]').forEach(b=>{
  b.addEventListener('click',()=>{
    const ch=b.getAttribute('data-ins');
    const start=answer.selectionStart||answer.value.length;
    const end=answer.selectionEnd||answer.value.length;
    const v=answer.value;
    answer.value = v.slice(0,start)+ch+v.slice(end);
    answer.focus();
    const pos=start+ch.length;
    answer.setSelectionRange(pos,pos);
  });
});

/* Keyboard shortcuts */
document.addEventListener('keydown',(e)=>{
  if(views.drill.classList.contains('active')){
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); checkBtn.click(); }
    else if(e.key==='Enter' && e.shiftKey){ e.preventDefault(); hintBtn.click(); }
    else if((e.altKey||e.metaKey) && (e.key==='a' || e.key==='A')){ e.preventDefault(); audioBtn.click(); }
    else if((e.altKey||e.metaKey) && (e.key==='s' || e.key==='S')){ e.preventDefault(); skipBtn.click(); }
    else if(e.key==='Escape'){ e.preventDefault(); panelBtn.click(); }
  }
});

/* ============ TOUR ============ */
tourBtn.onclick=()=>tour.classList.add('show');
closeTour.onclick=()=>tour.classList.remove('show');
tour.addEventListener('click',(e)=>{ if(e.target===tour) tour.classList.remove('show'); });

/* ============ THEME + PREFS ============ */
function savePrefs(){
  const prefs={
    theme:document.documentElement.getAttribute('data-theme')||'mono',
    strict:strict.checked, shuffle:shuffle.checked,
    mode:(document.querySelector('input[name="mode"]:checked')||{}).value||'en2es',
    ops:{add:opAdd.checked,sub:opSub.checked,div:opDiv.checked}, q:(+qCount.value||20)
  };
  localStorage.setItem('drill_prefs', JSON.stringify(prefs));
}
function loadPrefs(){
  try{
    const p=JSON.parse(localStorage.getItem('drill_prefs')||'{}');
    if(p.theme){ document.documentElement.setAttribute('data-theme', p.theme); themeSel.value=p.theme; }
    if(typeof p.strict==='boolean') strict.checked=p.strict;
    if(typeof p.shuffle==='boolean') shuffle.checked=p.shuffle;
    if(p.mode){
      const r=document.querySelector(`input[name="mode"][value="${p.mode}"]`);
      if(r) r.checked=true;
    }
    if(p.ops){ opAdd.checked=!!p.ops.add; opSub.checked=!!p.ops.sub; opDiv.checked=!!p.ops.div; }
    if(p.q) qCount.value=p.q;
  }catch{}
}
(function bootTheme(){
  const savedTheme=localStorage.getItem('theme');
  if(savedTheme){ document.documentElement.setAttribute('data-theme', savedTheme); themeSel.value=savedTheme; }
})();
themeSel.onchange=()=>{
  document.documentElement.setAttribute('data-theme', themeSel.value);
  localStorage.setItem('theme', themeSel.value);
  savePrefs();
};

/* ============ INIT ============ */
loadPrefs();
buildPanel(SETS.u1a1.items); // placeholder so panel isn't empty on very first open
</script>
</body>
</html>
